<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollabCode | Workspace</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <style>
        :root {
            /* --- COLOR PALETTE --- */
            --bg-app: #09090b;
            --bg-card: #18181b;
            --bg-input: #27272a;
            
            --border-color: #27272a;
            --border-hover: #3f3f46;
            
            --primary: #10b981;
            --primary-dark: #059669;
            --primary-glow: rgba(16, 185, 129, 0.15);
            
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            
            --text-main: #f4f4f5;
            --text-muted: #a1a1aa;
            
            /* --- SPACING & RADIUS --- */
            --radius-md: 8px;
            --radius-lg: 12px;
            --space-6: 24px;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; outline: none; }

        body {
            background-color: var(--bg-app);
            background-image: 
                radial-gradient(at 0% 0%, rgba(16, 185, 129, 0.05) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(59, 130, 246, 0.05) 0px, transparent 50%);
            color: var(--text-main);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            padding: 40px 20px;
            line-height: 1.5;
        }

        .container { width: 100%; max-width: 1100px; display: grid; grid-template-columns: 380px 1fr; gap: 24px; align-items: start; }
        @media (max-width: 900px) { .container { grid-template-columns: 1fr; } }

        /* --- CARDS --- */
        .card { background: rgba(24, 24, 27, 0.6); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px); border: 1px solid var(--border-color); border-radius: var(--radius-lg); padding: var(--space-6); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .header { margin-bottom: var(--space-6); display: flex; justify-content: space-between; align-items: center; }
        .header h2 { font-size: 18px; font-weight: 600; color: var(--text-main); display: flex; align-items: center; gap: 10px; }
        .header svg { color: var(--primary); height: 20px; width: 20px; }

        /* --- FORMS --- */
        .form-group { margin-bottom: 20px; }
        label { display: block; font-size: 13px; font-weight: 500; color: var(--text-muted); margin-bottom: 8px; }
        input, select { width: 100%; height: 42px; background: var(--bg-app); border: 1px solid var(--border-color); color: var(--text-main); padding: 0 12px; border-radius: var(--radius-md); font-size: 14px; transition: all 0.2s ease; }
        input:hover, select:hover { border-color: var(--border-hover); }
        input:focus, select:focus { border-color: var(--primary); box-shadow: 0 0 0 2px var(--primary-glow); }
        input.error { border-color: var(--danger); }
        .error-msg { color: var(--danger); font-size: 12px; margin-top: 6px; display: none; }

        /* --- BUTTONS --- */
        .btn-submit { width: 100%; height: 44px; background: var(--primary); color: #000; border: none; border-radius: var(--radius-md); font-weight: 600; font-size: 14px; cursor: pointer; transition: transform 0.1s, background-color 0.2s; }
        .btn-submit:hover:not(:disabled) { background-color: var(--primary-dark); }
        .btn-submit:active:not(:disabled) { transform: translateY(1px); }
        .btn-submit:disabled { opacity: 0.6; cursor: not-allowed; filter: grayscale(0.5); }
        .icon-btn { background: transparent; border: none; color: var(--text-muted); cursor: pointer; padding: 4px; border-radius: 4px; transition: color 0.2s; }
        .icon-btn:hover { color: var(--text-main); background: var(--bg-input); }

        /* --- RADIO & TOGGLES --- */
        .radio-group { display: flex; gap: 8px; }
        .radio-card { flex: 1; padding: 10px; border: 1px solid var(--border-color); background: var(--bg-app); border-radius: var(--radius-md); cursor: pointer; text-align: center; font-size: 13px; font-weight: 500; color: var(--text-muted); transition: all 0.2s; }
        .radio-card:hover { border-color: var(--border-hover); }
        .radio-card.selected { border-color: var(--primary); color: var(--primary); background: var(--primary-glow); }
        .toggle-wrapper { display: flex; align-items: center; justify-content: space-between; width: 100%; cursor: pointer; }
        .toggle-switch { position: relative; width: 36px; height: 20px; background: var(--bg-input); border-radius: 20px; transition: 0.3s; border: 1px solid var(--border-color); }
        .toggle-switch::after { content: ''; position: absolute; top: 2px; left: 2px; width: 14px; height: 14px; background: var(--text-muted); border-radius: 50%; transition: 0.3s; }
        input:checked + .toggle-switch { background: var(--primary); border-color: var(--primary); }
        input:checked + .toggle-switch::after { transform: translateX(16px); background: #fff; }

        /* --- ROOM LIST --- */
        .room-list { display: flex; flex-direction: column; gap: 12px; max-height: 600px; overflow-y: auto; padding-right: 4px; }
        .room-list::-webkit-scrollbar { width: 6px; }
        .room-list::-webkit-scrollbar-track { background: transparent; }
        .room-list::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 3px; }
        .room-item { background: var(--bg-app); border: 1px solid var(--border-color); border-radius: var(--radius-md); padding: 16px; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease; position: relative; }
        .room-item.expired { opacity: 0.5; border-style: dashed; }
        .room-info h3 { font-size: 15px; font-weight: 600; margin-bottom: 6px; color: var(--text-main); display: flex; align-items: center; gap: 8px; }
        .room-meta { display: flex; gap: 12px; font-size: 12px; color: var(--text-muted); align-items: center; font-family: 'JetBrains Mono', monospace; }
        .badge { padding: 2px 8px; border-radius: 4px; font-size: 10px; font-weight: 600; letter-spacing: 0.05em; text-transform: uppercase; border: 1px solid transparent; }
        .badge.private { color: #f59e0b; background: rgba(245, 158, 11, 0.1); border-color: rgba(245, 158, 11, 0.2); }
        .badge.public { color: var(--primary); background: rgba(16, 185, 129, 0.1); border-color: rgba(16, 185, 129, 0.2); }
        .badge.expired { color: var(--danger); background: var(--danger-bg); border-color: var(--danger); }
        
        .join-btn { background: transparent; border: 1px solid var(--border-color); color: var(--text-main); padding: 6px 14px; border-radius: var(--radius-md); cursor: pointer; font-size: 13px; font-weight: 500; transition: all 0.2s; }
        .join-btn:hover { background: var(--text-main); color: var(--bg-app); border-color: var(--text-main); }

        /* --- DROPDOWN MENU (NEW) --- */
        .actions-group { display: flex; align-items: center; gap: 8px; }
        .menu-wrapper { position: relative; }
        .menu-btn { background: transparent; border: none; color: var(--text-muted); padding: 6px; cursor: pointer; border-radius: 4px; display: flex; align-items: center; }
        .menu-btn:hover { background: var(--bg-input); color: var(--text-main); }
        
        .dropdown {
            position: absolute; right: 0; top: 100%; width: 180px; background: #18181b; 
            border: 1px solid var(--border-color); border-radius: 8px; padding: 4px; 
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.5); z-index: 50; display: none;
            transform-origin: top right; animation: scaleIn 0.1s ease;
        }
        .dropdown.show { display: block; }
        
        .dropdown-item {
            display: flex; align-items: center; gap: 8px; width: 100%; padding: 8px 12px;
            background: transparent; border: none; color: var(--text-muted); text-align: left;
            font-size: 13px; cursor: pointer; border-radius: 4px;
        }
        .dropdown-item:hover { background: var(--bg-input); color: var(--text-main); }
        .dropdown-item.danger { color: var(--danger); }
        .dropdown-item.danger:hover { background: rgba(239, 68, 68, 0.1); }
        
        @keyframes scaleIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body>

    <div class="container">
        
        <div class="card">
            <div class="header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    New Session
                </h2>
            </div>

            <div class="form-group">
                <label>Project Name</label>
                <input type="text" id="roomName" placeholder="e.g. Algo Practice" oninput="App.checkDuplicateName()" autocomplete="off">
                <div id="name-error" class="error-msg">A room with this name already exists.</div>
            </div>

            <div class="form-group">
                <label>Environment</label>
                <select id="language">
                    <option value="javascript">JavaScript (Node)</option>
                    <option value="python">Python 3</option>
                    <option value="java">Java 17</option>
                    <option value="cpp">C++ 20</option>
                    <option value="html">HTML5</option>
                </select>
            </div>

            <div class="form-group">
                <label>Guest Permissions</label>
                <div class="radio-group">
                    <div class="radio-card selected" onclick="App.toggleAccess('edit', this)">Collaborator</div>
                    <div class="radio-card" onclick="App.toggleAccess('view', this)">Spectator</div>
                </div>
            </div>

            <div class="form-group">
                <label>Auto-Destruct Timer</label>
                <select id="expiry">
                    <option value="never">Never Expire</option>
                    <option value="1h">1 Hour</option>
                    <option value="24h">24 Hours</option>
                </select>
            </div>

            <div class="form-group">
                <label for="privateToggle" class="toggle-wrapper">
                    <span style="font-size: 14px;">Password Protection</span>
                    <input type="checkbox" id="privateToggle" style="display:none;">
                    <div class="toggle-switch"></div>
                </label>
                <input type="password" id="roomPassword" placeholder="Enter session password..." style="margin-top: 12px; display: none;">
            </div>

            <button class="btn-submit" id="createBtn" onclick="App.createRoom()">Launch Environment</button>
        </div>

        <div class="card">
            <div class="header">
                <h2>
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
                    Your Dashboard
                </h2>
                <button class="icon-btn" onclick="App.loadDashboard()" title="Refresh List">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M23 4v6h-6"></path><path d="M1 20v-6h6"></path><path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path></svg>
                </button>
            </div>

            <div id="loading-rooms" style="text-align: center; padding: 40px; color: var(--text-muted); font-size: 13px;">
                Connecting to server...
            </div>
            
            <div id="room-list" class="room-list"></div>
        </div>

    </div>

    <script>
        const API_BASE = '/api';
        const socket = io(); 

        const App = {
            accessLevel: 'edit',
            cachedRooms: [],

            init() {
                // UI Toggles
                document.getElementById('privateToggle').addEventListener('change', (e) => {
                    const passInput = document.getElementById('roomPassword');
                    if(e.target.checked) {
                        passInput.style.display = 'block';
                        setTimeout(() => passInput.focus(), 50);
                    } else {
                        passInput.style.display = 'none';
                        passInput.value = '';
                    }
                });

                // Close dropdowns when clicking outside
                document.addEventListener('click', (e) => {
                    if (!e.target.closest('.menu-wrapper')) {
                        document.querySelectorAll('.dropdown').forEach(el => el.classList.remove('show'));
                    }
                });

                // Socket Listeners
                socket.emit('join_dashboard');
                socket.on('roomUpdate', (data) => this.updateRoomMemberCount(data.roomId, data.activeUsers));
                socket.on('roomExpired', (data) => this.markRoomExpired(data.roomId));
                socket.on('roomCreated', (room) => this.addRoomToList(room, true));
                
                // NEW: Listeners for updates
                socket.on('roomDeleted', (data) => this.removeRoomFromList(data.roomId));
                socket.on('roomAccessChanged', (data) => this.updateAccessBadge(data.roomId, data.accessLevel));

                this.loadDashboard();
            },

            // --- API ACTIONS (DELETE / UPDATE) ---
            async deleteRoom(roomId) {
                // if(!confirm("Are you sure? This action cannot be undone.")) return;
                
                try {
                    const res = await fetch(API_BASE + '/delete_room', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId })
                    });
                    if(!res.ok) alert("Failed to delete room");
                    // UI update handled via socket 'roomDeleted'
                } catch(e) { alert("Connection Error"); }
            },

            async changeAccess(roomId, newAccess) {
                try {
                    const res = await fetch(API_BASE + '/update_room_access', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ roomId, accessLevel: newAccess })
                    });
                    if(!res.ok) alert("Failed to update settings");
                    // UI update handled via socket 'roomAccessChanged'
                } catch(e) { alert("Connection Error"); }
            },

            // --- UI HELPERS ---
            toggleMenu(btn) {
                // Close others
                document.querySelectorAll('.dropdown').forEach(el => {
                    if(el !== btn.nextElementSibling) el.classList.remove('show');
                });
                btn.nextElementSibling.classList.toggle('show');
            },

            removeRoomFromList(roomId) {
                const el = document.getElementById(`room-${roomId}`);
                if (el) {
                    el.style.opacity = '0';
                    el.style.transform = 'translateX(20px)';
                    setTimeout(() => el.remove(), 300);
                    this.cachedRooms = this.cachedRooms.filter(r => r.id !== roomId);
                }
            },

            updateAccessBadge(roomId, level) {
                const card = document.getElementById(`room-${roomId}`);
                if (!card) return;
                
                // Update Badge
                const badge = card.querySelector('.badge:not(.expired)');
                if (badge) {
                    badge.className = `badge ${level === 'edit' ? 'public' : 'private'}`;
                    badge.innerText = level === 'edit' ? 'COLLABORATOR' : 'SPECTATOR';
                }

                // Update Menu Button Text
                const btn = card.querySelector('.access-toggle-btn');
                if (btn) {
                    const newAction = level === 'edit' ? 'view' : 'edit';
                    const newLabel = level === 'edit' ? 'Make View Only' : 'Make Editable';
                    const icon = level === 'edit' ? 'ðŸ”’' : 'ðŸ”“';
                    btn.innerHTML = `${icon} ${newLabel}`;
                    btn.onclick = () => this.changeAccess(roomId, newAction);
                }
            },

            // --- STANDARD LOGIC ---
            toggleAccess(level, el) {
                this.accessLevel = level;
                document.querySelectorAll('.radio-card').forEach(c => c.classList.remove('selected'));
                el.classList.add('selected');
            },

            checkDuplicateName() {
                const nameInput = document.getElementById('roomName');
                const errorMsg = document.getElementById('name-error');
                const btn = document.getElementById('createBtn');
                const enteredName = nameInput.value.trim().toLowerCase();
                const exists = this.cachedRooms.some(r => r.name.toLowerCase() === enteredName && r.status !== 'expired');

                if (exists) {
                    nameInput.classList.add('error');
                    errorMsg.style.display = 'block';
                    btn.disabled = true;
                    btn.innerText = "Name Taken";
                } else {
                    nameInput.classList.remove('error');
                    errorMsg.style.display = 'none';
                    btn.disabled = false;
                    btn.innerText = "Launch Environment";
                }
                return exists;
            },

            async createRoom() {
                if (this.checkDuplicateName()) return;
                const btn = document.getElementById('createBtn');
                const payload = {
                    name: document.getElementById('roomName').value || "Untitled",
                    language: document.getElementById('language').value,
                    expiry: document.getElementById('expiry').value,
                    accessLevel: this.accessLevel,
                    isPrivate: document.getElementById('privateToggle').checked,
                    password: document.getElementById('roomPassword').value
                };

                btn.innerText = "Creating...";
                btn.disabled = true;

                try {
                    const res = await fetch(API_BASE + '/create_room', {
                        method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload)
                    });
                    const data = await res.json();
                    if (data.id) window.location.href = `/room/${data.id}`;
                    else { alert("Error: " + (data.error || "Unknown")); btn.disabled = false; btn.innerText = "Launch Environment"; }
                } catch (e) { alert("Connection failed."); btn.disabled = false; btn.innerText = "Launch Environment"; }
            },

            async loadDashboard() {
                const list = document.getElementById('room-list');
                const loader = document.getElementById('loading-rooms');
                
                try {
                    const res = await fetch(API_BASE + '/dashboard');
                    if (res.status === 401 || res.redirected) { window.location.href = '/login?next=/'; return; }
                    const data = await res.json();
                    loader.style.display = 'none';
                    list.innerHTML = '';
                    this.cachedRooms = data.rooms || [];

                    if (!this.cachedRooms.length) {
                        list.innerHTML = `<div style="text-align:center; padding:30px; color:var(--text-muted); opacity:0.7;"><div style="font-size:13px;">No active sessions</div></div>`;
                        return;
                    }
                    this.cachedRooms.forEach(room => this.addRoomToList(room));
                } catch (e) { loader.innerText = "Failed to load rooms."; }
            },

            addRoomToList(room, prepend = false) {
                const list = document.getElementById('room-list');
                const isExpired = room.status === 'expired';
                if (prepend) this.cachedRooms.unshift(room);

                const item = document.createElement('div');
                item.className = `room-item ${isExpired ? 'expired' : ''}`;
                item.id = `room-${room.id}`;
                
                const userCountColor = (room.activeUsers > 0 && !isExpired) ? 'color:var(--primary)' : '';
                
                // Logic for menu actions
                const nextAccess = room.access === 'edit' ? 'view' : 'edit';
                const nextLabel = room.access === 'edit' ? 'Make View Only' : 'Make Editable';
                const accessIcon = room.access === 'edit' ? 'ðŸ”’' : 'ðŸ”“';

                item.innerHTML = `
                    <div class="room-info">
                        <h3>
                            ${room.name}
                            ${isExpired ? '<span class="badge expired">EXPIRED</span>' : ''}
                        </h3>
                        <div class="room-meta">
                            <span style="text-transform: capitalize;">${room.language}</span>
                            <span>â€¢</span>
                            <span class="badge ${room.access === 'edit' ? 'public' : 'private'}">${room.access === 'edit' ? 'COLLABORATOR' : 'SPECTATOR'}</span>
                            <span>â€¢</span>
                            <span style="display:flex; align-items:center; gap:5px; ${userCountColor}" class="user-indicator">
                                <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M23 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>
                                <span class="member-count">${room.activeUsers || 0}</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="actions-group">
                        <button class="join-btn" onclick="window.location.href='/room/${room.id}'">
                            ${isExpired ? 'View' : 'Open'}
                        </button>
                        
                        ${!isExpired ? `
                        <div class="menu-wrapper">
                            <button class="menu-btn" onclick="App.toggleMenu(this)">
                                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"></circle><circle cx="12" cy="5" r="1"></circle><circle cx="12" cy="19" r="1"></circle></svg>
                            </button>
                            <div class="dropdown">
                                <button class="dropdown-item access-toggle-btn" onclick="App.changeAccess('${room.id}', '${nextAccess}')">
                                    ${accessIcon} ${nextLabel}
                                </button>
                                <button class="dropdown-item danger" onclick="App.deleteRoom('${room.id}')">
                                    <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                    Delete Room
                                </button>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
                
                if (prepend) list.prepend(item);
                else list.appendChild(item);
            },

            updateRoomMemberCount(roomId, count) {
                const el = document.querySelector(`#room-${roomId} .member-count`);
                const wrapper = document.querySelector(`#room-${roomId} .user-indicator`);
                if (el && wrapper) {
                    el.innerText = count;
                    wrapper.style.color = count > 0 ? 'var(--primary)' : 'var(--text-muted)';
                }
            },

            markRoomExpired(roomId) {
                const card = document.getElementById(`room-${roomId}`);
                if (card && !card.classList.contains('expired')) {
                    card.classList.add('expired');
                    
                    if (!card.querySelector('.badge.expired')) {
                        const title = card.querySelector('h3');
                        title.innerHTML += ' <span class="badge expired">EXPIRED</span>';
                    }
                    
                    const btn = card.querySelector('.join-btn');
                    btn.innerText = 'View';
                    
                    // Hide Menu for expired rooms
                    const menu = card.querySelector('.menu-wrapper');
                    if(menu) menu.style.display = 'none';
                    
                    const cached = this.cachedRooms.find(r => r.id === roomId);
                    if (cached) cached.status = 'expired';
                }
            }
        };

        App.init();
    </script>
</body>
</html>