<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CollabCode Pro</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            /* Professional Dark Theme Palette */
            --bg-app: #09090b;       /* Deepest black/gray */
            --bg-panel: #121214;     /* Slightly lighter for panels */
            --bg-header: rgba(18, 18, 20, 0.8); /* Translucent */
            --border: #27272a;       /* Subtle borders */
            --border-active: #3f3f46;
            
            --accent-primary: #22c55e; /* Vibrant Green */
            --accent-glow: rgba(34, 197, 94, 0.2);
            --accent-hover: #16a34a;
            
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --success: #22c55e;
            
            --font-ui: 'Inter', system-ui, -apple-system, sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * { box-sizing: border-box; }

        body {
            margin: 0; padding: 0;
            background-color: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex; flex-direction: column; overflow: hidden;
            -webkit-font-smoothing: antialiased;
        }

        /* --- HEADER --- */
        header {
            height: 64px;
            background-color: var(--bg-header);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
            padding: 0 24px;
            z-index: 50;
            position: relative;
        }

        .brand-group { display: flex; align-items: center; gap: 20px; }
        
        .brand { 
            font-weight: 700; font-size: 18px; color: #fff; 
            display: flex; align-items: center; gap: 12px; 
            letter-spacing: -0.02em;
        }

        /* Refined Pulse Animation */
        .status-dot {
            width: 8px; height: 8px;
            background-color: var(--success);
            border-radius: 50%;
            position: relative;
            box-shadow: 0 0 10px var(--accent-glow);
        }
        .status-dot::after {
            content: ''; position: absolute; top: -4px; left: -4px;
            width: 16px; height: 16px;
            background-color: var(--success);
            border-radius: 50%;
            opacity: 0.4;
            animation: pulse-ring 2.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        @keyframes pulse-ring { 
            0% { transform: scale(0.5); opacity: 0; } 
            50% { opacity: 0.5; } 
            100% { transform: scale(1.5); opacity: 0; } 
        }

        .room-badge {
            background: linear-gradient(135deg, rgba(56, 139, 253, 0.1), rgba(56, 139, 253, 0.05));
            color: #60a5fa;
            border: 1px solid rgba(56, 139, 253, 0.2);
            padding: 4px 12px;
            border-radius: 6px;
            font-size: 11px;
            font-family: var(--font-code);
            font-weight: 500;
            letter-spacing: 0.05em;
        }

        /* Modern Select Styling */
        .language-select {
            background-color: var(--bg-panel);
            color: var(--text-main);
            border: 1px solid var(--border);
            padding: 8px 36px 8px 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 500;
            font-family: var(--font-ui);
            outline: none;
            cursor: pointer;
            appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%23a1a1aa' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            transition: all 0.2s ease;
        }
        .language-select:hover { border-color: var(--border-active); background-color: #1a1a1e; }
        .language-select:focus { border-color: #60a5fa; box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.1); }

        /* Professional Run Button */
        .btn-run {
            background: var(--accent-primary);
            color: #000; /* Better contrast on bright green */
            border: none;
            padding: 0 20px;
            height: 36px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 700;
            cursor: pointer;
            display: flex; align-items: center; gap: 8px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            font-family: var(--font-ui);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            box-shadow: 0 4px 12px rgba(34, 197, 94, 0.25);
        }
        .btn-run:hover { 
            background-color: var(--accent-hover); 
            transform: translateY(-1px); 
            box-shadow: 0 6px 16px rgba(34, 197, 94, 0.35);
        }
        .btn-run:active { transform: translateY(0); box-shadow: 0 2px 4px rgba(34, 197, 94, 0.2); }
        .btn-run svg { width: 16px; height: 16px; fill: currentColor; }
        
        /* Loading State */
        .btn-run.loading { 
            background-color: #27272a; 
            color: var(--text-muted); 
            cursor: wait; 
            box-shadow: none;
            pointer-events: none;
        }
        .btn-run.loading svg { 
            fill: var(--text-muted);
            animation: spin 0.8s linear infinite; 
        }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- WORKSPACE LAYOUT --- */
        .workspace {
            display: flex;
            flex: 1;
            flex-direction: row; 
            height: calc(100vh - 64px);
            overflow: hidden;
            background-color: var(--bg-app);
        }

        .editor-wrapper {
            flex: 1;
            min-width: 0; 
            position: relative;
            background-color: var(--bg-app); /* Match editor theme background */
        }

        .right-panel {
            width: 400px;
            min-width: 320px;
            max-width: 50%;
            background-color: var(--bg-panel);
            display: flex; flex-direction: column;
            border-left: 1px solid var(--border);
            z-index: 10;
        }

        /* --- RESPONSIVE --- */
        @media (max-width: 768px) {
            header { padding: 0 16px; }
            .brand span { display: none; }
            .workspace { flex-direction: column; }
            .right-panel {
                width: 100%;
                max-width: none;
                height: 45vh;
                border-left: none;
                border-top: 1px solid var(--border);
            }
            .room-badge { display: none; } 
        }

        /* --- IO PANELS --- */
        .io-container { display: flex; flex-direction: column; flex: 1; height: 100%; }
        
        .panel-section { display: flex; flex-direction: column; flex: 1; min-height: 0; }
        
        .panel-header {
            padding: 12px 20px; 
            background: var(--bg-panel);
            font-size: 11px; 
            font-weight: 700; 
            text-transform: uppercase; 
            letter-spacing: 0.08em;
            color: var(--text-muted); 
            border-bottom: 1px solid var(--border); 
            border-top: 1px solid var(--border);
            display: flex; align-items: center; gap: 8px; user-select: none;
        }
        .panel-section:first-child .panel-header { border-top: none; }

        .terminal-input, .terminal-output {
            flex: 1; width: 100%; 
            background: #0c0c0e; /* Slightly darker than panel for input area */
            border: none;
            color: var(--text-main); 
            padding: 16px 20px;
            font-family: var(--font-code); 
            font-size: 13px; 
            line-height: 1.6;
            resize: none; outline: none;
        }
        .terminal-input:focus { background: #000; }

        .section-input { height: 35%; flex: none; border-bottom: 1px solid var(--border); }
        .section-output { flex: 1; }

        .terminal-output.error { color: #f87171; border-left: 3px solid var(--danger); }
        .terminal-output.success { color: #4ade80; }

        /* HTML Preview */
        .preview-container {
            display: none; flex: 1; height: 100%;
            background-color: white; flex-direction: column;
        }
        .preview-header {
            background: #f6f8fa; color: #24292f; padding: 12px 16px;
            font-size: 12px; font-weight: 600; border-bottom: 1px solid #d0d7de;
            display: flex; align-items: center; justify-content: space-between;
        }
        iframe { width: 100%; height: 100%; border: none; }

        /* Utility */
        .hidden { display: none !important; }
        .visible { display: flex !important; }
        
        /* Modern Scrollbar */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background-color: #3f3f46; border: 2px solid var(--bg-panel); border-radius: 100px; }
        ::-webkit-scrollbar-thumb:hover { background-color: #52525b; }
        
        /* Monaco Editor Overrides for Theme Consistency */
        .monaco-editor, .monaco-editor-background { background-color: var(--bg-app) !important; }
        .margin { background-color: var(--bg-app) !important; }
    </style>
</head>

<body>

    <header>
        <div class="brand-group">
            <div class="brand">
                <div class="status-dot" title="Live Connection"></div>
                <span>CollabCode <span style="font-weight:400; opacity:0.6; font-size:16px;">Pro</span></span>
            </div>
            <div class="room-badge">ROOM: <%=roomid%></div>

            <select id="language-select" class="language-select">
                <option value="javascript">JavaScript</option>
                <option value="python">Python</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="html">HTML</option>
            </select>
        </div>
        <div class="actions">
            <button class="btn-run" id="run-btn">
                <svg viewBox="0 0 24 24"><path d="M8 5v14l11-7z"></path></svg>
                <span>Run Code</span>
            </button>
        </div>
    </header>

    <div class="workspace">
        <div class="editor-wrapper" id="editor"></div>

        <div class="right-panel">
            <div class="io-container" id="io-layout">
                <div class="panel-section section-input">
                    <div class="panel-header">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16M4 12l6-6m-6 6l6 6"/></svg>
                        STDIN (Input)
                    </div>
                    <textarea class="terminal-input" id="input-box" placeholder="Enter custom input here..."></textarea>
                </div>
                <div class="panel-section section-output">
                    <div class="panel-header">
                        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 12h16m0 0l-6-6m6 6l-6 6"/></svg>
                        STDOUT (Output)
                    </div>
                    <div class="terminal-output" id="output-box" tabindex="0">
                        <span style="opacity: 0.5; font-style: italic;">// Output will appear here after execution</span>
                    </div>
                </div>
            </div>

            <div class="preview-container" id="preview-layout">
                <div class="preview-header">
                    <span style="display:flex; align-items:center; gap:8px;">
                        <svg width="14" height="14" viewBox="0 0 16 16" fill="#57606a"><path d="M8 0a8 8 0 100 16A8 8 0 008 0zM1.5 8a6.5 6.5 0 1113 0 6.5 6.5 0 01-13 0z"/></svg>
                        Live Preview
                    </span>
                    <span style="font-size:10px; color:#57606a; font-family: sans-serif;">localhost:3000</span>
                </div>
                <iframe id="preview-frame"></iframe>
            </div>
        </div>
    </div>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <script>
        /* ================= 1. CONFIG & HELPERS ================= */

        const BOILERPLATES = {
            javascript: `// JavaScript\nconsole.log("Hello World");`,
            python: `# Python 3\nprint("Hello World")`,
            java: `public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}`,
            cpp: `#include <iostream>\n\nint main() {\n    std::cout << "Hello World" << std::endl;\n    return 0;\n}`,
            html: `<!DOCTYPE html>\n<html>\n<head>\n    <style>\n        body { font-family: sans-serif; padding: 20px; }\n        h1 { color: #238636; }\n    </style>\n</head>\n<body>\n    <h1>Hello World</h1>\n    <p>This is a live preview.</p>\n</body>\n</html>`
        };

        function getColorFromUserId(userId) {
            let hash = 0;
            for (let i = 0; i < userId.length; i++) hash = userId.charCodeAt(i) + ((hash << 5) - hash);
            return `hsl(${Math.abs(hash) % 360}, 85%, 65%)`;
        }

        function ensureCursorStyle(userId, color) {
            const id = `cursor-style-${userId}`;
            if (document.getElementById(id)) return;
            const style = document.createElement("style");
            style.id = id;
            style.innerHTML = `
                .remote-cursor-${userId} { border-left: 2px solid ${color}; height: 20px; position: absolute; } 
                .remote-cursor-${userId}::after { 
                    content: "${userId.slice(0, 4)}"; 
                    position: absolute; top: -18px; left: -2px; 
                    background-color: ${color}; color: #121212; 
                    font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 800; 
                    padding: 2px 6px; border-radius: 4px 4px 4px 0; 
                    pointer-events: none; z-index: 100; white-space: nowrap; 
                    box-shadow: 0 2px 5px rgba(0,0,0,0.4);
                }
            `;
            document.head.appendChild(style);
        }

        function ensureSelectionStyle(userId, color) {
            const id = `selection-style-${userId}`;
            if (document.getElementById(id)) return;
            const style = document.createElement("style");
            style.id = id;
            style.innerHTML = `.remote-selection-${userId} { background-color: ${color}; opacity: 0.25; }`;
            document.head.appendChild(style);
        }

        /* ================= 2. INITIALIZATION ================= */
        require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.45.0/min/vs" } });

        require(["vs/editor/editor.main"], () => {
            
            // --- Editor Setup ---
            const editor = monaco.editor.create(document.getElementById("editor"), {
                value: "// Connecting...",
                language: "javascript",
                theme: "vs-dark",
                automaticLayout: true,
                fontSize: 14,
                fontFamily: "'JetBrains Mono', 'Fira Code', monospace",
                fontLigatures: true,
                minimap: { enabled: false },
                readOnly: true, // Locked until synced
                bracketPairColorization: { enabled: true },
                padding: { top: 24, bottom: 24 },
                cursorBlinking: "smooth",
                cursorSmoothCaretAnimation: "on",
                overviewRulerBorder: false,
                lineNumbersMinChars: 4,
                scrollBeyondLastLine: false
            });

            // Adjust Editor Theme colors to match new UI
            monaco.editor.defineTheme('custom-dark', {
                base: 'vs-dark',
                inherit: true,
                rules: [],
                colors: {
                    'editor.background': '#09090b',
                }
            });
            monaco.editor.setTheme('custom-dark');

            const roomId = "<%=roomid%>";
            const socket = io();
            
            // --- UI References ---
            const langSelect = document.getElementById("language-select");
            const ioLayout = document.getElementById("io-layout");
            const previewLayout = document.getElementById("preview-layout");
            const previewFrame = document.getElementById("preview-frame");
            const outputBox = document.getElementById("output-box");
            const inputBox = document.getElementById("input-box");
            const runBtn = document.getElementById("run-btn");

            // --- State ---
            let isSynced = false;
            let isApplyingRemote = false;
            let docVersion = 0;
            let lastEmit = 0;
            let remoteCursors = {};
            let remoteSelections = {};
            let hasActiveSelection = false;
            let lastSelection = null;

            // --- Layout Switcher ---
            function updateLayout(lang) {
                if (lang === 'html') {
                    ioLayout.classList.add('hidden');
                    previewLayout.classList.add('visible');
                } else {
                    ioLayout.classList.remove('hidden');
                    previewLayout.classList.remove('visible');
                }
            }

            // --- Socket: Connection & Sync ---
            socket.on("connect", () => socket.emit("join_room", roomId));

            socket.on("syncSnapshot", ({ content, version, language }) => {
                isApplyingRemote = true;
                const initialContent = content || BOILERPLATES[language || 'javascript'];
                editor.setValue(initialContent);

                if (language) {
                    const model = editor.getModel();
                    monaco.editor.setModelLanguage(model, language);
                    langSelect.value = language;
                    updateLayout(language);
                }
                
                editor.updateOptions({ readOnly: false });
                isApplyingRemote = false;
                docVersion = version;
                isSynced = true;
            });

            // --- Socket: Editing ---
            socket.on("editorOp", ({ changes, version }) => {
                if (!isSynced) return;
                isApplyingRemote = true;
                const edits = changes.map(c => ({ range: c.range, text: c.text, forceMoveMarkers: true }));
                editor.getModel().applyEdits(edits);
                isApplyingRemote = false;
                docVersion = version;
            });
            
            socket.on("ack", ({ version }) => { docVersion = version; });

            editor.onDidChangeModelContent(e => {
                if (!isSynced || isApplyingRemote) return;
                socket.emit("editorOp", { roomId, changes: e.changes, baseVersion: docVersion });
            });

            // --- Socket: Language ---
            langSelect.addEventListener("change", (e) => {
                const newLang = e.target.value;
                const model = editor.getModel();
                monaco.editor.setModelLanguage(model, newLang);
                updateLayout(newLang);
                
                // Smart Boilerplate: Only if empty or very short
                if (editor.getValue().trim().length < 20) {
                     editor.setValue(BOILERPLATES[newLang]);
                }
                socket.emit("languageChange", { roomId, language: newLang });
            });

            socket.on("languageUpdate", (newLang) => {
                monaco.editor.setModelLanguage(editor.getModel(), newLang);
                langSelect.value = newLang;
                updateLayout(newLang);
            });

            // --- Socket: Cursors ---
            editor.onDidChangeCursorPosition(e => {
                if (Date.now() - lastEmit < 50) return;
                lastEmit = Date.now();
                socket.volatile.emit("cursorMove", { roomId, position: e.position });
            });

            socket.on("cursorUpdate", ({ userId, position }) => {
                const color = getColorFromUserId(userId);
                ensureCursorStyle(userId, color);
                const decoration = { 
                    range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column), 
                    options: { className: `remote-cursor-${userId}`, stickiness: monaco.editor.TrackedRangeStickiness.NeverGrowsWhenTypingAtEdges } 
                };
                remoteCursors[userId] = editor.deltaDecorations(remoteCursors[userId] || [], [decoration]);
            });

            // --- Socket: Selection (FIXED ROBUST LOGIC) ---
            editor.onDidChangeCursorSelection(e => {
                const sel = e.selection;
                
                // 1. Handle Empty Selection (Clear)
                if (sel.isEmpty()) {
                    if (hasActiveSelection) {
                        hasActiveSelection = false;
                        lastSelection = null;
                        socket.emit("selectionClear", { roomId });
                    }
                    return;
                }

                // 2. Handle Active Selection
                hasActiveSelection = true;
                const data = { 
                    startLineNumber: sel.startLineNumber, 
                    startColumn: sel.startColumn, 
                    endLineNumber: sel.endLineNumber, 
                    endColumn: sel.endColumn 
                };
                
                // Prevent duplicate emits
                if (JSON.stringify(lastSelection) === JSON.stringify(data)) return;
                lastSelection = data;
                
                socket.volatile.emit("selectionChange", { roomId, selection: data });
            });

            // Fallback clear on blur
            editor.onDidBlurEditorWidget(() => { 
                if(hasActiveSelection) {
                    hasActiveSelection = false;
                    lastSelection = null;
                    socket.emit("selectionClear", { roomId });
                }
            });

            socket.on("selectionUpdate", ({ userId, selection }) => {
                const color = getColorFromUserId(userId);
                ensureSelectionStyle(userId, color);
                const decoration = { range: new monaco.Range(selection.startLineNumber, selection.startColumn, selection.endLineNumber, selection.endColumn), options: { className: `remote-selection-${userId}` } };
                remoteSelections[userId] = editor.deltaDecorations(remoteSelections[userId] || [], [decoration]);
            });
            
            socket.on("selectionClear", (userId) => {
                if (remoteSelections[userId]) {
                    editor.deltaDecorations(remoteSelections[userId], []);
                    delete remoteSelections[userId];
                }
            });

            socket.on("userDisconnected", (userId) => {
                if (remoteCursors[userId]) { editor.deltaDecorations(remoteCursors[userId], []); delete remoteCursors[userId]; }
                if (remoteSelections[userId]) { editor.deltaDecorations(remoteSelections[userId], []); delete remoteSelections[userId]; }
            });

            /* ================= 3. EXECUTION ENGINE ================= */
            
            runBtn.addEventListener("click", async () => {
                const lang = langSelect.value;
                const code = editor.getValue();
                const input = inputBox.value;

                // UI Loading State
                runBtn.classList.add("loading");
                const originalBtnContent = runBtn.innerHTML;
                runBtn.innerHTML = `<svg viewBox="0 0 24 24"><path d="M12 4V2A10 10 0 0 0 2 12h2a8 8 0 0 1 8-8z"></path></svg> RUNNING`;

                try {
                    // 1. HTML PREVIEW
                    if (lang === 'html') {
                        const doc = previewFrame.contentDocument || previewFrame.contentWindow.document;
                        doc.open(); doc.write(code); doc.close();
                        runBtn.classList.remove("loading");
                        runBtn.innerHTML = originalBtnContent;
                        return;
                    }

                    // 2. LOCAL JAVASCRIPT
                    if (lang === 'javascript') {
                        outputBox.innerText = "";
                        outputBox.className = "terminal-output";
                        const logs = [];
                        const originalLog = console.log;
                        console.log = (...args) => logs.push(args.map(a => (typeof a === 'object' ? JSON.stringify(a, null, 2) : a)).join(' '));
                        
                        try {
                            const runFunc = new Function('INPUT', code);
                            runFunc(input);
                            outputBox.innerText = logs.length ? logs.join('\n') : "Executed successfully (No output)";
                            if (logs.length) outputBox.classList.add("success");
                        } catch (err) {
                            outputBox.innerText = "Runtime Error: " + err.message;
                            outputBox.classList.add("error");
                        } finally { 
                            console.log = originalLog; 
                        }
                        
                        runBtn.classList.remove("loading");
                        runBtn.innerHTML = originalBtnContent;
                        return;
                    }

                    // 3. REMOTE EXECUTION (Piston API)
                    outputBox.innerText = "Compiling and running on remote server...";
                    outputBox.className = "terminal-output";

                    const languageMap = { "python": "python", "java": "java", "cpp": "c++" };
                    const versionMap = { "python": "3.10.0", "java": "15.0.2", "cpp": "10.2.0" };
                    const files = (lang === 'java') ? [{ name: "Main.java", content: code }] : [{ content: code }];

                    const response = await fetch("https://emkc.org/api/v2/piston/execute", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({
                            language: languageMap[lang],
                            version: versionMap[lang],
                            files: files,
                            stdin: input
                        })
                    });

                    const data = await response.json();

                    if (data.run) {
                        outputBox.innerText = data.run.output || "Executed successfully (No output)";
                        if (data.run.stderr) outputBox.classList.add("error");
                        else outputBox.classList.add("success");
                    } else {
                        outputBox.innerText = "Error: " + (data.message || "Failed to execute");
                        outputBox.classList.add("error");
                    }

                } catch (err) {
                    outputBox.innerText = "System Error: " + err.message;
                    outputBox.classList.add("error");
                } finally {
                    runBtn.classList.remove("loading");
                    runBtn.innerHTML = originalBtnContent;
                }
            });
        });
    </script>
</body>
</html>