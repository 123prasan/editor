<!DOCTYPE html>
<html lang="en" data-theme="dark">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CollabCode Enterprise | Room <%= roomid %>
    </title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500;700&display=swap"
        rel="stylesheet">

    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        /* --- DESIGN SYSTEM (Midnight Pro) --- */
        :root {
            --bg-app: #09090b;
            --bg-panel: #141417;
            --bg-sidebar: #0c0c0e;
            --bg-active: #27272a;
            --border: #27272a;
            --primary: #22c55e;
            --primary-hover: #16a34a;
            --primary-glow: rgba(34, 197, 94, 0.2);
            --danger: #ef4444;
            --warning: #f59e0b;
            --text-main: #e4e4e7;
            --text-muted: #a1a1aa;
            --header-h: 56px;
            --font-ui: 'Inter', sans-serif;
            --font-code: 'JetBrains Mono', monospace;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            background: var(--bg-app);
            color: var(--text-main);
            font-family: var(--font-ui);
            height: 100vh;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* --- LAYOUT --- */
        .app-header {
            height: var(--header-h);
            background: rgba(9, 9, 11, 0.95);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 16px;
            z-index: 50;
        }

        .workspace {
            display: flex;
            flex: 1;
            height: calc(100vh - var(--header-h) - 28px);
            position: relative;
        }

        .sidebar {
            width: 260px;
            background: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            transition: transform 0.3s;
            z-index: 20;
        }

        .editor-region {
            flex: 1;
            position: relative;
            min-width: 0;
        }

        .output-region {
            width: 350px;
            background: var(--bg-panel);
            border-left: 1px solid var(--border);
            display: flex;
            flex-direction: column;
        }

        /* --- COMPONENTS --- */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            height: 32px;
            padding: 0 12px;
            border-radius: 6px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: 0.2s;
        }

        .btn-primary {
            background: var(--primary);
            color: #000;
        }

        .btn-primary:hover:not(:disabled) {
            background: var(--primary-hover);
            transform: translateY(-1px);
        }

        .btn-icon {
            background: transparent;
            color: var(--text-muted);
            width: 32px;
            padding: 0;
        }

        .btn-icon:hover {
            background: var(--bg-active);
            color: var(--text-main);
        }

        .select-input {
            height: 32px;
            background: var(--bg-app);
            border: 1px solid var(--border);
            color: var(--text-main);
            border-radius: 6px;
            padding: 0 8px;
            font-size: 13px;
            cursor: pointer;
        }

        .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-family: var(--font-code);
            background: var(--bg-active);
            border: 1px solid var(--border);
        }

        .badge.danger {
            background: rgba(239, 68, 68, 0.1);
            color: var(--danger);
            border-color: var(--danger);
        }

        /* --- TERMINAL --- */
        .panel-tabs {
            display: flex;
            border-bottom: 1px solid var(--border);
            background: var(--bg-sidebar);
        }

        .panel-tab {
            flex: 1;
            padding: 10px;
            text-align: center;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-muted);
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .panel-tab.active {
            color: var(--text-main);
            border-bottom-color: var(--primary);
            background: var(--bg-panel);
        }

        .panel-content {
            flex: 1;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-content.active {
            display: flex;
        }

        .terminal-display {
            flex: 1;
            padding: 16px;
            font-family: var(--font-code);
            font-size: 13px;
            overflow-y: auto;
            white-space: pre-wrap;
        }

        .terminal-input {
            height: 80px;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border);
            color: var(--text-main);
            padding: 12px;
            border: none;
            resize: none;
            font-family: var(--font-code);
        }

        /* --- UTILS --- */
        .loader {
            width: 30px;
            height: 30px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s infinite;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .toast-container {
            position: fixed;
            bottom: 40px;
            right: 24px;
            z-index: 300;
            display: flex;
            flex-direction: column;
            gap: 10px;
            pointer-events: none;
        }

        .toast {
            pointer-events: auto;
            background: var(--bg-panel);
            border: 1px solid var(--border);
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 500;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 10px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                transform: translateY(20px);
                opacity: 0;
            }

            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        /* --- FOOTER --- */
        .app-footer {
            height: 28px;
            background: var(--bg-sidebar);
            border-top: 1px solid var(--border);
            display: flex;
            align-items: center;
            padding: 0 16px;
            font-family: var(--font-code);
            font-size: 11px;
            color: var(--text-muted);
            gap: 16px;
        }

        @media(max-width: 900px) {
            .workspace {
                flex-direction: column;
            }

            .sidebar {
                display: none;
                position: absolute;
                height: 100%;
                box-shadow: 10px 0 30px rgba(0, 0, 0, 0.5);
            }

            .sidebar.open {
                display: flex;
            }

            .output-region {
                width: 100%;
                height: 35vh;
                border-left: none;
                border-top: 1px solid var(--border);
            }
        }
    </style>
</head>

<body>

    <div id="loading-overlay"
        style="position:fixed; inset:0; background:rgba(9,9,11,0.95); z-index:500; display:flex; align-items:center; justify-content:center; flex-direction:column;">
        <div class="loader"></div>
        <div style="margin-top:16px; font-weight:600; color:var(--text-muted);">Connecting to Environment...</div>
    </div>

    <div id="toast-area" class="toast-container"></div>

    <header class="app-header">
        <div style="display:flex; gap:16px; align-items:center;">
            <div style="font-weight:700; display:flex; align-items:center; gap:10px;">
                <div id="status-dot" style="width:8px; height:8px; border-radius:50%; background:var(--danger);"></div>
                CollabCode
            </div>
            <button class="btn-icon" onclick="UI.toggleSidebar()"><i data-lucide="panel-left" width="18"></i></button>
            <div class="badge" id="timer-display" style="display:flex; gap:6px; align-items:center;">
                <i data-lucide="clock" width="12"></i> --:--:--
            </div>
        </div>

        <div style="display:flex; gap:12px; align-items:center;">
            <select id="language-select" class="select-input" style="width:140px;">
                <option value="javascript">JavaScript</option>
                <option value="python">Python</option>
                <option value="java">Java</option>
                <option value="cpp">C++</option>
                <option value="html">HTML5</option>
            </select>
            <button class="btn btn-primary" id="run-btn" onclick="Runner.execute()">
                <i data-lucide="play" width="14"></i> Run
            </button>
            <button class="btn-icon" onclick="UI.shareRoom()"><i data-lucide="share-2" width="18"></i></button>
        </div>
    </header>

    <div class="workspace">
        <aside class="sidebar" id="sidebar">
            <div
                style="padding:16px; border-bottom:1px solid var(--border); font-weight:600; font-size:12px; color:var(--text-muted);">
                ACTIVE USERS (<span id="user-count">0</span>)</div>
            <div id="user-list" style="flex:1; overflow-y:auto; padding:8px;"></div>
            <div style="padding:16px; border-top:1px solid var(--border);">
                <button class="btn" style="width:100%; background:var(--bg-active); color:var(--text-main);"
                    onclick="Editor.download()">
                    <i data-lucide="download" width="14"></i> Download
                </button>
            </div>
        </aside>

        <main class="editor-region">
            <div id="monaco-container" style="width:100%; height:100%;"></div>
        </main>

        <aside class="output-region">
            <div class="panel-tabs">
                <div class="panel-tab active" onclick="UI.switchTab('io')">Console</div>
                <div class="panel-tab" onclick="UI.switchTab('web')">Preview</div>
            </div>
            <div id="tab-io" class="panel-content active">
                <div
                    style="padding:8px; display:flex; justify-content:flex-end; border-bottom:1px solid var(--border);">
                    <button class="btn-icon" onclick="UI.clearConsole()"><i data-lucide="trash-2"
                            width="14"></i></button>
                </div>
                <div id="console-output" class="terminal-display">
                    <span style="opacity:0.5">// Output...</span>
                </div>
                <textarea id="stdin-input" class="terminal-input" placeholder="Stdin..."></textarea>
            </div>
            <div id="tab-web" class="panel-content" style="background:white;">
                <iframe id="web-frame" style="width:100%; height:100%; border:none;"></iframe>
            </div>
        </aside>
    </div>

    <footer class="app-footer">
        <div id="access-badge" class="badge">Detecting...</div>
        <div style="margin-left:auto;" id="cursor-coords">Ln 1, Col 1</div>
        <div id="socket-id">Disconnected</div>
    </footer>

    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://unpkg.com/monaco-editor@0.45.0/min/vs/loader.js"></script>

    <script>
        lucide.createIcons();

        /* ================= STATE ================= */
        const Store = {
            roomId: "<%= roomid %>",
            isSynced: false,
            isTransactionRemote: false, // Mutex Lock
            docVersion: 0,
            accessLevel: 'edit',
            language: 'javascript',
            users: new Map(), // userId -> { color }
            boilerplates: {
                javascript: `console.log("Hello World");`,
                python: `print("Hello World")`,
                java: `public class Main {\n    public static void main(String[] args) {\n        System.out.println("Hello World");\n    }\n}`,
                cpp: `#include <iostream>\n\nint main() {\n    std::cout << "Hello World";\n    return 0;\n}`,
                html: `<!DOCTYPE html>\n<html>\n<body>\n    <h1>Hello World</h1>\n</body>\n</html>`
            }
        };

        /* ================= UTILS ================= */
        const Utils = {
            // Generate consistent HSL colors based on User ID
            getHue(str) {
                let hash = 0;
                for (let i = 0; i < str.length; i++) hash = str.charCodeAt(i) + ((hash << 5) - hash);
                return Math.abs(hash) % 360;
            },
            formatTime(ms) {
                if (ms <= 0) return "00:00:00";
                const h = Math.floor(ms / 3600000).toString().padStart(2, '0');
                const m = Math.floor((ms % 3600000) / 60000).toString().padStart(2, '0');
                const s = Math.floor((ms % 60000) / 1000).toString().padStart(2, '0');
                return `${h}:${m}:${s}`;
            }
        };

        /* ================= UI CONTROLLER ================= */
        const UI = {
            setLoading(show) { document.getElementById('loading-overlay').style.display = show ? 'flex' : 'none'; },

            setOnline(online) {
                document.getElementById('status-dot').style.background = online ? 'var(--primary)' : 'var(--danger)';
                document.getElementById('status-dot').style.boxShadow = online ? '0 0 8px var(--primary-glow)' : 'none';
                if (online) this.setLoading(false);
            },

            setAccess(level) {
                Store.accessLevel = level;
                const isView = level === 'view';
                const badge = document.getElementById('access-badge');
                badge.innerText = isView ? 'READ ONLY' : 'EDITOR';
                badge.className = isView ? 'badge danger' : 'badge';
                document.getElementById('run-btn').disabled = isView;
                document.getElementById('language-select').disabled = isView;
                if (Editor.monaco) Editor.monaco.updateOptions({ readOnly: isView });
                if (isView) this.toast("Read-Only Mode Active", "warning");
            },

            updateTimer(expiryIso) {
                if (!expiryIso) { document.getElementById('timer-display').innerText = "âˆž"; return; }
                const end = new Date(expiryIso).getTime();
                setInterval(() => {
                    const diff = end - Date.now();
                    if (diff <= 0) {
                        document.getElementById('timer-display').innerText = "EXPIRED";
                        this.setAccess('view');
                        return;
                    }
                    document.getElementById('timer-display').innerText = Utils.formatTime(diff);
                }, 1000);
            },

            updateUsers() {
                const list = document.getElementById('user-list');
                list.innerHTML = '';
                document.getElementById('user-count').innerText = Store.users.size;
                Store.users.forEach((data, id) => {
                    const hue = Utils.getHue(id);
                    const color = `hsl(${hue}, 75%, 60%)`;

                    const el = document.createElement('div');
                    el.style.padding = '8px'; el.style.borderBottom = '1px solid rgba(255,255,255,0.05)'; el.style.display = 'flex'; el.style.gap = '10px'; el.style.alignItems = 'center';
                    el.innerHTML = `
                        <div style="width:24px;height:24px;border-radius:4px;background:${color}20;color:${color};display:flex;align-items:center;justify-content:center;font-weight:700;font-size:10px;">
                            ${id.slice(0, 2).toUpperCase()}
                        </div> 
                        <span style="font-size:13px;color:var(--text-main);">User ${id.slice(0, 4)}</span>
                    `;
                    list.appendChild(el);
                });
            },

            toast(msg, type = 'info') {
                const area = document.getElementById('toast-area');
                const el = document.createElement('div');
                el.className = 'toast';
                el.style.borderLeft = `4px solid ${type === 'warning' ? 'var(--warning)' : 'var(--primary)'}`;
                el.innerHTML = `<span>${msg}</span>`;
                area.appendChild(el);
                setTimeout(() => el.remove(), 3000);
            },

            switchTab(tab) {
                document.querySelectorAll('.panel-tab').forEach(e => e.classList.remove('active'));
                document.querySelectorAll('.panel-content').forEach(e => e.classList.remove('active'));
                document.getElementById(`tab-${tab}`).classList.add('active');
                if (tab === 'io') document.querySelectorAll('.panel-tab')[0].classList.add('active');
                else document.querySelectorAll('.panel-tab')[1].classList.add('active');
            },

            toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); },
            clearConsole() { document.getElementById('console-output').innerText = "// Output cleared"; },
            shareRoom() { navigator.clipboard.writeText(window.location.href); this.toast("Copied to Clipboard"); }
        };

        /* ================= EDITOR ENGINE ================= */
        const Editor = {
            monaco: null,
            remoteCursors: {},
            remoteSelections: {},

            init() {
                require.config({ paths: { vs: "https://unpkg.com/monaco-editor@0.45.0/min/vs" } });
                require(["vs/editor/editor.main"], () => {
                    monaco.editor.defineTheme('midnight', { base: 'vs-dark', inherit: true, rules: [], colors: { 'editor.background': '#09090b' } });

                    this.monaco = monaco.editor.create(document.getElementById("monaco-container"), {
                        value: "", language: "javascript", theme: "midnight",
                        automaticLayout: true, fontSize: 14, fontFamily: "'JetBrains Mono', monospace",
                        minimap: { enabled: true, scale: 0.75 }, padding: { top: 20 }, readOnly: true
                    });

                    // --- EVENTS ---
                    this.monaco.onDidChangeModelContent(e => {
                        if (Store.isTransactionRemote || !Store.isSynced) return;
                        Socket.emitOp(e.changes, Store.docVersion);
                    });

                    this.monaco.onDidChangeCursorPosition(e => {
                        Socket.emitCursor(e.position);
                        document.getElementById('cursor-coords').innerText = `Ln ${e.position.lineNumber}, Col ${e.position.column}`;
                    });

                    // Broadcast Selection
                    this.monaco.onDidChangeCursorSelection(e => {
                        if (e.selection.isEmpty()) {
                            Socket.emitSelectionClear();
                        } else {
                            Socket.emitSelection(e.selection);
                        }
                    });



                    Socket.connect();
                });
            },

            // --- REMOTE UPDATES (MUTEX PROTECTED) ---
            setContent(content, version, lang) {
                Store.isTransactionRemote = true; // LOCK
                const current = this.monaco.getValue();
                if (content !== null && content !== current) {
                    this.monaco.setValue(content || Store.boilerplates[lang]);
                }
                if (lang && lang !== Store.language) {
                    monaco.editor.setModelLanguage(this.monaco.getModel(), lang);
                    Store.language = lang;
                    document.getElementById('language-select').value = lang;
                    if (lang === 'html') UI.switchTab('web'); else UI.switchTab('io');
                }
                Store.docVersion = version;
                Store.isSynced = true;
                if (Store.accessLevel === 'edit') this.monaco.updateOptions({ readOnly: false });
                Store.isTransactionRemote = false; // UNLOCK
            },

            applyEdits(changes, version) {
                Store.isTransactionRemote = true; // LOCK
                const edits = changes.map(c => ({ range: c.range, text: c.text, forceMoveMarkers: true }));
                this.monaco.getModel().applyEdits(edits);
                Store.docVersion = version;
                Store.isTransactionRemote = false; // UNLOCK
            },

            // --- VISUALS ---
            ensureUserStyle(userId) {
                const styleId = `style-${userId}`;
                if (document.getElementById(styleId)) return;

                const hue = Utils.getHue(userId);
                // We use HSLA for background to ensure text remains readable (no opacity inheritance)
                const colorSolid = `hsl(${hue}, 75%, 60%)`;
                const colorTransparent = `hsla(${hue}, 75%, 60%, 0.25)`;

                const style = document.createElement('style');
                style.id = styleId;
                style.innerHTML = `
                    .cur-${userId} { border-left: 2px solid ${colorSolid} !important; }
                    .cur-${userId}::after { 
                        content: "${userId.slice(0, 4)}"; position: absolute; top: -18px; left: -2px; 
                        background: ${colorSolid}; color: #000; font-size: 10px; padding: 1px 4px; border-radius: 4px; 
                        font-weight: bold; pointer-events: none; white-space: nowrap; z-index: 10;
                    }
                    /* Using inlineClassName ensures background doesn't override text color */
                    .sel-${userId} { background-color: ${colorTransparent} !important; }
                `;
                document.head.appendChild(style);
            },

            updateRemoteCursor(userId, position) {
                this.ensureUserStyle(userId);
                const decorations = [{
                    range: new monaco.Range(position.lineNumber, position.column, position.lineNumber, position.column),
                    options: { className: `cur-${userId}` }
                }];
                this.remoteCursors[userId] = this.monaco.deltaDecorations(this.remoteCursors[userId] || [], decorations);
            },

            updateRemoteSelection(userId, selection) {
                this.ensureUserStyle(userId);
                // Validate selection (avoid drawing if start === end)
                if (selection.startLineNumber === selection.endLineNumber && selection.startColumn === selection.endColumn) {
                    this.clearRemoteSelection(userId);
                    return;
                }

                const decorations = [{
                    range: new monaco.Range(selection.startLineNumber, selection.startColumn, selection.endLineNumber, selection.endColumn),
                    options: { inlineClassName: `sel-${userId}` } // Changed from className to inlineClassName
                }];
                this.remoteSelections[userId] = this.monaco.deltaDecorations(this.remoteSelections[userId] || [], decorations);
            },

            clearRemoteSelection(userId) {
                if (this.remoteSelections[userId]) {
                    this.monaco.deltaDecorations(this.remoteSelections[userId], []);
                    delete this.remoteSelections[userId];
                }
            },

            removeUser(userId) {
                if (this.remoteCursors[userId]) this.monaco.deltaDecorations(this.remoteCursors[userId], []);
                this.clearRemoteSelection(userId);
                const style = document.getElementById(`style-${userId}`);
                if (style) style.remove();
            },

            download() {
                const blob = new Blob([this.monaco.getValue()], { type: "text/plain" });
                const a = document.createElement("a");
                a.href = window.URL.createObjectURL(blob);
                a.download = `code.${Store.language === 'javascript' ? 'js' : 'txt'}`;
                a.click();
            }
        };

        /* ================= SOCKET ================= */
        const Socket = {
            io: null,
            connect() {
                this.io = io();
                this.io.on('connect', () => {
                    UI.setOnline(true);
                    document.getElementById('socket-id').innerText = `ID: ${this.io.id.slice(0, 6)}`;
                    this.io.emit('join_room', Store.roomId);
                });
                this.io.on('disconnect', () => UI.setOnline(false));

                // --- DATA SYNC ---
                this.io.on('syncSnapshot', (data) => {
                    if (data.expiry) UI.updateTimer(data.expiry);
                    if (data.accessLevel) UI.setAccess(data.accessLevel);
                    Editor.setContent(data.content, data.version, data.language);
                    UI.toast("Joined Successfully");
                });

                this.io.on('editorOp', (data) => Editor.applyEdits(data.changes, data.version));
                this.io.on('resync', (data) => { Editor.setContent(data.content, data.version, data.language); UI.toast("Resynced", "warning"); });
                this.io.on('languageUpdate', (lang) => { Editor.setContent(null, Store.docVersion, lang); UI.toast(`Lang: ${lang}`); });

                // --- PRESENCE ---
                this.io.on('cursorUpdate', ({ userId, position }) => {
                    if (!Store.users.has(userId)) {
                        Store.users.set(userId, {}); // Color handled by CSS injector
                        UI.updateUsers();
                    }
                    Editor.updateRemoteCursor(userId, position);
                });

                this.io.on('selectionUpdate', ({ userId, selection }) => {
                    // Force register user if missing to ensure highlight shows
                    if (!Store.users.has(userId)) {
                        Store.users.set(userId, {});
                        UI.updateUsers();
                    }
                    Editor.updateRemoteSelection(userId, selection);
                });

                this.io.on('selectionClear', (userId) => {
                    Editor.clearRemoteSelection(userId);
                });

                this.io.on('userDisconnected', (userId) => {
                    Editor.removeUser(userId);
                    Store.users.delete(userId);
                    UI.updateUsers();
                    UI.toast("User Left");
                });
            },

            emitOp(changes, v) { this.io.emit('editorOp', { roomId: Store.roomId, changes, baseVersion: v }); },
            emitCursor(pos) { this.io.volatile.emit('cursorMove', { roomId: Store.roomId, position: pos }); },
            emitSelection(sel) {
                this.io.emit('selectionChange', {
                    roomId: Store.roomId,
                    selection: {
                        startLineNumber: sel.startLineNumber,
                        startColumn: sel.startColumn,
                        endLineNumber: sel.endLineNumber,
                        endColumn: sel.endColumn
                    }
                });
            },

            emitSelectionClear() { this.io.emit('selectionClear', { roomId: Store.roomId }); },
            emitLang(lang) { this.io.emit('languageChange', { roomId: Store.roomId, language: lang }); }
        };

        /* ================= RUNNER ================= */
        const Runner = {
            async execute() {
                if (Store.accessLevel === 'view') return;
                const lang = Store.language;
                const code = Editor.monaco.getValue();
                const btn = document.getElementById('run-btn');
                const out = document.getElementById('console-output');

                if (lang === 'html') {
                    const doc = document.getElementById('web-frame').contentDocument;
                    doc.open(); doc.write(code); doc.close();
                    UI.switchTab('web'); return;
                }

                btn.disabled = true; btn.innerHTML = `<div class="loader" style="width:14px; height:14px; border-width:2px; margin:0; display:inline-block"></div>`;
                out.innerText = "Running..."; UI.switchTab('io');

                try {
                    const res = await fetch(CONFIG.pistonUrl, {
                        method: "POST", headers: { "Content-Type": "application/json" },
                        body: JSON.stringify({ language: lang === 'python' ? 'python' : lang === 'cpp' ? 'c++' : lang, version: "*", files: [{ content: code }], stdin: document.getElementById('stdin-input').value })
                    });
                    const data = await res.json();
                    if (data.run) {
                        out.innerText = data.run.output || "No Output.";
                        out.style.color = data.run.stderr ? "var(--danger)" : "var(--text-main)";
                    } else out.innerText = "Error: " + data.message;
                } catch (e) { out.innerText = "Error: " + e.message; }
                finally { btn.disabled = false; btn.innerHTML = `<i data-lucide="play" width="14"></i> Run`; lucide.createIcons(); }
            }
        };

        document.getElementById('language-select').addEventListener('change', (e) => {
            if (Store.accessLevel === 'view') { e.target.value = Store.language; return; }
            const lang = e.target.value;
            if (Editor.monaco.getValue().length < 15) Editor.monaco.setValue(Store.boilerplates[lang]);
            Socket.emitLang(lang);
        });

        Editor.init();
    </script>
</body>

</html>